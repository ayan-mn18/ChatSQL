# Azure VM Deployment Workflow
# This workflow deploys the ChatSQL application to an Azure VM using a self-hosted runner

name: Azure Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Uses the GitHub runner installed on your Azure VM

    strategy:
      matrix:
        node-version: [22.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Create .env file
      run: | 
        touch .env
        echo "${{ secrets.PROD }}" > .env
    
    - name: Build project
      run: npm run build --if-present
    
    - name: Install PM2 globally (if not exists)
      run: |
        if ! command -v pm2 &> /dev/null; then
          echo "ğŸ“¦ Installing PM2..."
          npm i -g pm2
        else
          echo "âœ… PM2 already installed"
        fi
    
    - name: Stop and delete existing PM2 process
      run: |
        if pm2 describe chatsql > /dev/null 2>&1; then
          echo "ğŸ›‘ Stopping existing chatsql process..."
          pm2 stop chatsql
          pm2 delete chatsql
          echo "âœ… Existing process stopped and deleted"
        else
          echo "â„¹ï¸ No existing chatsql process found"
        fi
    
    - name: Start new PM2 process
      run: |
        echo "ğŸš€ Starting new chatsql process..."
        pm2 start dist/server.js --name chatsql
        pm2 save
        echo "âœ… chatsql started successfully"
    
    - name: Verify deployment
      run: |
        echo "ğŸ“Š PM2 Status:"
        pm2 status
        echo ""
        echo "ğŸ” Checking if application is running..."
        sleep 5
        if pm2 describe chatsql | grep -q "online"; then
          echo "âœ… Application is running successfully!"
        else
          echo "âŒ Application may have issues. Check logs with: pm2 logs chatsql"
          exit 1
        fi
